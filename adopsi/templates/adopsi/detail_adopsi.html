{% extends 'adopsi/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Detail Adopsi - SIZOPI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">


    <div class="flex items-center space-x-3 mb-8">
        <a href="{% url 'adopsi:dashboard_adopter' %}" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
            <i class="fas fa-arrow-left mr-1"></i> Kembali
        </a>
        <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">Detail Adopsi</h1>
    </div>
    

    
    <!-- Status Section -->
    <div class="flex flex-wrap gap-4 mb-6">
        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium
            {% if adopsi.tgl_berhenti_adopsi < now.date %}
                bg-gray-200 text-gray-800
            {% else %}
                bg-green-100 text-green-800
            {% endif %}
        ">
            <i class="fas fa-calendar-check mr-2"></i>
            {% if adopsi.tgl_berhenti_adopsi < now.date %}
                Status: Berakhir
            {% else %}
                Status: Aktif
            {% endif %}
        </div>
        
        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium
            {% if adopsi.status_pembayaran == 'lunas' %}
                bg-green-100 text-green-800
            {% else %}
                bg-yellow-100 text-yellow-800
            {% endif %}
        ">
            <i class="fas {% if adopsi.status_pembayaran == 'lunas' %}fa-check-circle{% else %}fa-clock{% endif %} mr-2"></i>
            Pembayaran: {{ adopsi.status_pembayaran|title }}
        </div>
    </div>

    <!-- Informasi Hewan -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
        <div class="bg-green-600 px-6 py-4">
            <h2 class="text-xl font-semibold text-white flex items-center">
                <i class="fas fa-paw mr-2"></i> Informasi Hewan
            </h2>
        </div>
        <div class="p-6">
            <div class="flex flex-col md:flex-row gap-8">
                <div class="md:w-1/3">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Detail Satwa</h3>
                        <div class="mb-4">
                            <img src="{{ hewan.url_foto.url }}" alt="{{ hewan.nama|default:hewan.spesies }}" class="w-full h-48 object-cover rounded">
                        </div>
                        <div class="space-y-2">
                            <p class="text-gray-800"><span class="font-medium">Nama:</span> {{ hewan.nama|default:"-" }}</p>
                            <p class="text-gray-800"><span class="font-medium">Spesies:</span> {{ hewan.spesies }}</p>
                            <p class="text-gray-800"><span class="font-medium">ID Hewan:</span> {{ hewan.id|truncatechars:10 }}</p>
                            <p class="text-gray-800"><span class="font-medium">Status Kesehatan:</span> {{ hewan.status_kesehatan }}</p>
                        </div>
                    </div>
                </div>
                <div class="md:w-2/3 space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Detail Periode Adopsi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-600 text-sm">Tanggal Mulai Adopsi</p>
                                <p class="font-semibold">{{ adopsi.tgl_mulai_adopsi|date:"j F Y" }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Tanggal Akhir Adopsi</p>
                                <p class="font-semibold">{{ adopsi.tgl_berhenti_adopsi|date:"j F Y" }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Durasi Adopsi</p>
                                <p class="font-semibold">
                                    {% with duration=adopsi.tgl_berhenti_adopsi|timeuntil:adopsi.tgl_mulai_adopsi %}
                                        {{ duration }}
                                    {% endwith %}
                                </p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Kontribusi Finansial</p>
                                <p class="font-semibold text-blue-600">Rp{{ adopsi.kontribusi_finansial|intcomma }}</p>
                            </div>
                        </div>
                    </div>
                    
                    {% if hewan.deskripsi or hewan.kebutuhan_khusus %}
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tentang {{ hewan.nama|default:hewan.spesies }}</h3>
                        {% if hewan.deskripsi %}
                        <div class="mb-4">
                            <p class="text-gray-700 leading-relaxed">
                                {{ hewan.deskripsi }}
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if hewan.kebutuhan_khusus %}
                        <div>
                            <h4 class="font-semibold text-md mb-2">Kebutuhan Khusus:</h4>
                            <p class="text-gray-700">{{ hewan.kebutuhan_khusus }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Buttons Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <a href="{% url 'adopsi:laporan_kondisi' adopsi.id_adopter.id_adopter adopsi.id_hewan.id tgl_mulai_adopsi_str %}" 
           class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded shadow transition flex items-center justify-center">
            <i class="fas fa-notes-medical mr-2"></i> Lihat Laporan Kondisi
        </a>

        <button type="button"
                class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded shadow transition flex items-center justify-center show-modal" 
                data-modal-target="sertifikatModal">
            <i class="fas fa-certificate mr-2"></i> Lihat Sertifikat
        </button>

        <button type="button"
                class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-4 rounded shadow transition flex items-center justify-center show-modal"
                data-modal-target="perpanjangModal">
            <i class="fas fa-clock mr-2"></i> Perpanjang Adopsi
        </button>

        <button type="button"
                class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded shadow transition flex items-center justify-center show-modal"
                data-modal-target="terminateModal">
            <i class="fas fa-times-circle mr-2"></i> Berhenti Adopsi
        </button>
    </div>
</div>

<!-- Sertifikat Modal -->
<div id="sertifikatModal" class="hidden fixed inset-0 z-50 overflow-auto">
    <div class="fixed inset-0 bg-black opacity-50"></div>
    <div class="relative bg-white rounded-lg max-w-3xl mx-auto mt-16 z-10 shadow-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-xl font-bold text-gray-900">Sertifikat Adopsi</h3>
            <button type="button" class="close-modal text-gray-400 hover:text-gray-500 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="border border-gray-300 rounded-lg p-8 text-center bg-white mb-6">
                <h1 class="text-2xl font-bold mb-8">Sertifikat Adopsi Satwa</h1>

                <p class="leading-relaxed mb-8">
                    Sertifikat ini diberikan kepada<br>
                    <span class="text-xl font-semibold">
                        {% if adopter_type == "individu" %}
                            {{ adopter_detail.nama }}
                        {% elif adopter_type == "organisasi" %}
                            {{ adopter_detail.nama_organisasi }}
                        {% else %}
                            {{ pengunjung.username_p }}
                        {% endif %}
                    </span><br>
                    yang telah mengadopsi secara simbolis<br>
                    <span class="font-semibold">{{ hewan.spesies }}</span>
                    bernama <span class="font-semibold">{{ hewan.nama|default:"(tanpa nama)" }}</span><br>
                    di taman safari kami pada periode<br>
                    <span class="font-semibold">
                        {{ adopsi.tgl_mulai_adopsi|date:"j F Y" }} – {{ adopsi.tgl_berhenti_adopsi|date:"j F Y" }}
                    </span>.
                </p>

                <p class="mb-12">
                    Kami sangat berterima kasih atas kepedulian dan kontribusi Anda<br>
                    terhadap pelestarian satwa di SIZOPI.
                </p>

                <div class="flex justify-between items-center">
                    <div class="text-left">
                        <p class="font-medium">SIZOPI</p>
                        <p class="text-sm">{{ now|date:"d F Y" }}</p>
                    </div>
                    <img src="{% static 'logo.png' %}" alt="Logo" class="h-16 opacity-80">
                </div>
            </div>
            

        </div>
    </div>
</div>

<!-- Perpanjang Adopsi Modal -->
<div id="perpanjangModal" class="hidden fixed inset-0 z-50">
    <div class="fixed inset-0 bg-black opacity-50"></div>
    <div class="relative bg-white rounded-lg max-w-2xl mx-auto mt-16 z-10 shadow-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-xl font-bold text-gray-900">Form Perpanjang Periode Adopsi Satwa</h3>
            <button type="button" class="close-modal text-gray-400 hover:text-gray-500 focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <!-- Form Perpanjang -->
            <form method="post" action="{% url 'adopsi:perpanjang_adopsi' adopsi.id_adopter.id_adopter adopsi.id_hewan.id tgl_mulai_adopsi_str %}" class="space-y-6">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Kolom Kiri: Informasi Satwa dan Adopter -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Detail Satwa</h4>
                            <div class="mb-3">
                                <img src="{{ hewan.url_foto.url }}" alt="{{ hewan.nama|default:hewan.spesies }}" class="w-full h-36 object-cover rounded">
                            </div>
                            <p class="text-gray-800"><span class="font-medium">Nama:</span> {{ hewan.nama|default:"-" }}</p>
                            <p class="text-gray-800"><span class="font-medium">Spesies:</span> {{ hewan.spesies }}</p>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Data Adopter</h4>
                            {% if adopter_type == "individu" %}
                                <p><span class="font-medium">Nama:</span> {{ adopter_detail.nama }}</p>
                                <p><span class="font-medium">NIK:</span> {{ adopter_detail.nik }}</p>
                            {% elif adopter_type == "organisasi" %}
                                <p><span class="font-medium">Nama Organisasi:</span> {{ adopter_detail.nama_organisasi }}</p>
                                <p><span class="font-medium">NPP:</span> {{ adopter_detail.npp }}</p>
                            {% else %}
                                <p><span class="font-medium">Username:</span> {{ pengunjung.username_p }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Kolom Kanan: Detail Perpanjangan -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Detail Perpanjangan</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="kontribusi" class="block text-sm font-medium text-gray-700 mb-1">Nominal Kontribusi (Rp)</label>
                                    <input type="number" name="kontribusi" id="kontribusi" 
                                        value="{{ adopsi.kontribusi_finansial }}"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label for="periode" class="block text-sm font-medium text-gray-700 mb-1">Periode Perpanjangan</label>
                                    <select name="periode" id="periode" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="3">3 Bulan</option>
                                        <option value="6">6 Bulan</option>
                                        <option value="12">12 Bulan</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Info Periode</h4>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm">Periode Saat Ini</p>
                                    <p class="font-semibold">
                                        {{ adopsi.tgl_mulai_adopsi|date:"j F Y" }} – {{ adopsi.tgl_berhenti_adopsi|date:"j F Y" }}
                                    </p>
                                </div>
                                <div id="newPeriodContainer">
                                    <p class="text-gray-600 text-sm">Perpanjangan Hingga</p>
                                    <p class="font-semibold text-blue-600" id="newEndDate">-</p>
                                </div>
                            </div>
                            
                            <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded">
                                <p><i class="fas fa-info-circle mr-1"></i> Perpanjangan akan dimulai dari tanggal berakhir adopsi saat ini.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pernyataan Adopsi -->
                <div class="bg-gray-50 p-4 rounded-lg mt-4">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">Pernyataan Perpanjangan Adopsi</h4>
                    <div class="text-gray-700 space-y-2">
                        <p>(selanjutnya disebut sebagai Adopter)</p>
                        <p>dengan ini menyatakan kepedulian dan minat untuk lanjut mengadopsi secara simbolis satwa</p>
                        <p>Nama: {{ hewan.nama|default:"-" }}{% if not hewan.nama %}(tanpa nama){% endif %}</p>
                        <p>Jenis: {{ hewan.spesies }}</p>
                        <p>Adopter juga bersedia memberikan kontribusi finansial kepada pihak taman safari sebagai dukungan untuk pemeliharaan satwa:</p>
                        <p>Nominal: Rp<span id="kontribusiDisplay">{{ adopsi.kontribusi_finansial }}</span></p>
                        <p>untuk memperpanjang periode adopsi selama <span id="periodeDisplay">3</span> bulan.</p>
                    </div>
                </div>
                
                <div class="pt-2 border-t border-gray-200 mt-4">
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded font-medium">
                            Batal
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded font-medium hover:bg-blue-700 transition">
                            Perpanjang Adopsi
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fungsi untuk memperbarui tampilan tanggal akhir perpanjangan
        function updateNewEndDate() {
            const periodeDropdown = document.getElementById('periode');
            const selectedPeriod = parseInt(periodeDropdown.value);
            
            // Memperbarui teks periode di pernyataan
            document.getElementById('periodeDisplay').textContent = selectedPeriod;
            
            // Ambil tanggal akhir saat ini
            const currentEndDate = new Date('{{ adopsi.tgl_berhenti_adopsi|date:"Y-m-d" }}');
            
            // Tambahkan bulan sesuai dengan periode yang dipilih
            const newEndDate = new Date(currentEndDate);
            newEndDate.setMonth(newEndDate.getMonth() + selectedPeriod);
            
            // Format tanggal untuk ditampilkan
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('newEndDate').textContent = newEndDate.toLocaleDateString('id-ID', options);
        }
        
        // Fungsi untuk memformat nilai nominal kontribusi
        function updateKontribusiDisplay() {
            const kontribusiInput = document.getElementById('kontribusi');
            const kontribusiValue = parseInt(kontribusiInput.value);
            
            // Format nilai untuk ditampilkan dengan pemisah ribuan
            const formattedValue = new Intl.NumberFormat('id-ID').format(kontribusiValue);
            document.getElementById('kontribusiDisplay').textContent = formattedValue;
        }
        
        // Tambahkan event listener untuk dropdown periode
        const periodeDropdown = document.getElementById('periode');
        if (periodeDropdown) {
            periodeDropdown.addEventListener('change', updateNewEndDate);
            // Inisialisasi tampilan tanggal saat pertama kali dimuat
            updateNewEndDate();
        }
        
        // Tambahkan event listener untuk input kontribusi
        const kontribusiInput = document.getElementById('kontribusi');
        if (kontribusiInput) {
            kontribusiInput.addEventListener('input', updateKontribusiDisplay);
            // Inisialisasi tampilan kontribusi saat pertama kali dimuat
            updateKontribusiDisplay();
        }
    });
</script>

<!-- Terminate Adoption Modal -->
<div id="terminateModal" class="hidden fixed inset-0 z-50">
    <div class="fixed inset-0 bg-black opacity-50"></div>
    <div class="relative bg-white rounded-lg max-w-md mx-auto mt-20 z-10 shadow-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-900">Konfirmasi Penghentian Adopsi</h3>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-4">Apakah Anda yakin ingin menghentikan adopsi ini? Tindakan ini akan mengubah tanggal berakhir adopsi menjadi hari ini.</p>
            
            <div class="flex justify-end space-x-3">
                <button type="button" class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded font-medium">
                    Batal
                </button>
                <form method="post" action="{% url 'adopsi:berhenti_adopsi' adopsi.id_adopter.id_adopter adopsi.id_hewan.id tgl_mulai_adopsi_str %}">
                    {% csrf_token %}
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded font-medium">
                        Ya, Hentikan
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show modals
        const showModalButtons = document.querySelectorAll('.show-modal');
        showModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-modal-target');
                const modal = document.getElementById(targetId);
                if (modal) {
                    modal.classList.remove('hidden');
                }
            });
        });
        
        // Close modals
        const closeModalButtons = document.querySelectorAll('.close-modal');
        closeModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.fixed.inset-0');
                if (modal) {
                    modal.classList.add('hidden');
                }
            });
        });
        
        // Close modal when clicking outside
        const modals = document.querySelectorAll('.fixed.inset-0');
        modals.forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === this.firstElementChild) {
                    this.classList.add('hidden');
                }
            });
        });
    });
    
  
        

</script>

{% endblock %}
